name: Push repo test
on:
  push
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2.3.4
      - uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: Create pull request
        env:
          PUSH_REPO_TOKEN: ${{ secrets.PUSH_REPO_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.PUSH_REPO_TOKEN }}
        run: |
          CLONE_DIR=$(mktemp -d)
          USER_NAME="GitHubActions"
          BRANCH_NAME="schema-updates"
          SOURCE_DIR="utils"
          TARGET_DIRECTORY="hello"
          DESTINATION_REPOSITORY_NAME="NickLewry/beer-utiful.git"

          echo "[+] Cloning destination git repository $DESTINATION_REPOSITORY_NAME"

          git config --global user.name $USER_NAME
          git config --global user.email 'actions@github.com'

          git clone --single-branch --branch "master" "https://github.com/$DESTINATION_REPOSITORY_NAME" "$CLONE_DIR"

          ls -la "$CLONE_DIR"

          TEMP_DIR=$(mktemp -d)

          mv "$CLONE_DIR/.git" "$TEMP_DIR/.git"

          if [ -n "$TARGET_DIRECTORY" ]
          then

            echo "[+] Checking if $TARGET_DIRECTORY exist in git repo $DESTINATION_REPOSITORY_NAME"

            # Remove contents of target directory and create a new empty one
            if [ -d "$CLONE_DIR/$TARGET_DIRECTORY/" ]
            then
              echo "[+] Deleting files from $TARGET_DIRECTORY in git repo $DESTINATION_REPOSITORY_NAME"
              rm -R "$CLONE_DIR/$TARGET_DIRECTORY/"
            fi

            echo "[+] Creating $TARGET_DIRECTORY if it doesnt already exist"

            mkdir -p "$CLONE_DIR/$TARGET_DIRECTORY"

            echo "[+] Listing Current Directory Location"
            ls -al

            echo "[+] Listing root Location"
            ls -al /
          fi

          mv "$TEMP_DIR/.git" "$CLONE_DIR/.git"

          echo "[+] Copying contents of source repository folder $SOURCE_DIR to folder $TARGET_DIRECTORY in git repo $DESTINATION_REPOSITORY_NAME"
          cp -ra "$SOURCE_DIR"/. "$CLONE_DIR/$TARGET_DIRECTORY"
          cd "$CLONE_DIR"

          git checkout -b $BRANCH_NAME

          echo "[+] Adding git commit"
          git add .

          echo "[+] git status:"
          git status

          # echo "[+] git diff-index:"
          # # git diff-index : to avoid doing the git commit failing if there are no changes to be commit
          git diff-index --quiet HEAD || git commit --message "schema updates"

          echo "[+] Pushing git commit"
          git push --force --set-upstream "https://$PUSH_REPO_TOKEN@github.com/$DESTINATION_REPOSITORY_NAME/" $BRANCH_NAME

          hub pr list --base "schema updates"

          # echo "Creating pull request"
          # hub pull-request -b "master" -h $BRANCH_NAME --no-edit
